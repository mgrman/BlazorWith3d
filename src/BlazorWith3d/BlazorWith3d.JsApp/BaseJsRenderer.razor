@using BlazorWith3d.Shared
@using Microsoft.JSInterop
@inject IJSRuntime JsRuntime
@inject ILogger<BaseJsRenderer> Logger
@using Microsoft.Extensions.Logging
@implements IAsyncDisposable

<canvas @ref="_containerElementReference" class="my-component"   style="width: 100%; height: 100%; position: relative;"  tabindex="-1">
    This component is defined in the <strong>BlazorWith3d.ExampleApp.Client.Babylon</strong> library.
</canvas>


@code{

    protected ElementReference _containerElementReference;
    private IJSObjectReference? module;
    protected IJSObjectReference? _typescriptApp;
    
    public virtual string JsAppPath => "";
    
    private DotNetObjectReference<JsMessageReceiverProxy>? _messageReceiverProxyReference;


    public virtual async ValueTask DisposeAsync()
    {
        if (_typescriptApp != null)
        {
            await _typescriptApp.InvokeVoidAsync("Quit");
            await _typescriptApp.DisposeAsync();
            _typescriptApp = null;
        }

        _messageReceiverProxyReference?.Dispose();
    }

    protected override void OnInitialized()
    {
        _messageReceiverProxyReference = DotNetObjectReference.Create(CreateReceiverProxy());
        base.OnInitialized();
    }

    protected virtual JsMessageReceiverProxy CreateReceiverProxy()
    {
        return new JsMessageReceiverProxy();
    }


    protected async Task InitializeTypeScriptApp()
    {
        if (string.IsNullOrEmpty(JsAppPath))
        {
            throw new InvalidOperationException($"{nameof(JsAppPath)} is not overriden!");
        }

        if (_messageReceiverProxyReference== null)
        {
            throw new InvalidOperationException($"{nameof(_messageReceiverProxyReference)} is not initialized!");
        }


        var moduleTask = new Lazy<Task<IJSObjectReference>>(() => JsRuntime.InvokeAsync
            <IJSObjectReference>
            ("import", JsAppPath).AsTask());
        
        module = await moduleTask.Value;
        
        
        _typescriptApp = await InitializeJsApp(module, _messageReceiverProxyReference);
    }

    protected virtual async Task<IJSObjectReference?> InitializeJsApp(IJSObjectReference module, DotNetObjectReference<JsMessageReceiverProxy> messageReceiverProxyReference)
    {
        throw new InvalidOperationException();
    }


    protected class JsMessageReceiverProxy()
    {
    }
}

           